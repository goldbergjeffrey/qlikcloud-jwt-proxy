<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Hello World!</title>

    <!-- Import the webpage's javascript file -->
    <link rel="stylesheet" href="https://jwt-proxy-combined.qlik.repl.co/resources/autogenerated/qlik-styles.css" />
    <script src="https://jwt-proxy-combined.qlik.repl.co/resources/assets/external/requirejs/require.js"></script>
    <script>
        const params = (new URL(window.location)).searchParams
        const sessionId = params.get("sessionId")
        const config = {
            host: "jwt-proxy-combined.qlik.repl.co",
            port: 443,
            prefix: "/",
            isSecure: true,
        };

        require.config({
            baseUrl: `https://${config.host}/resources`,
        });

        const registerServiceWorker = async () => {
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        navigator.serviceWorker.ready.then(registration => {
                            registration.active.postMessage({type:'setProxyHeader', sessionId})
                            ws = window.WebSocket;
                            window.WebSocket = function (a, b) {
                                const newUrl = new URL(a)
                                newUrl.searchParams.append('sessionId', sessionId)
                                
                                var newWS = b ? new ws(newUrl.toString(), b) : new ws(newUrl.toString())
                                return newWS;
                            };
                            window.WebSocket.prototype=ws.prototype;

                            window.history.pushState(null, null, '/')
                            renderSheet(config)
                            renderIframe()
                        })
                    })
                    .catch(error => {
                        console.error(`Registration failed with ${error}`)
                    })
            }
        }

        function createGrid(querySelector, columns, rows) {
            const gridContainer = document.querySelector(querySelector);
            gridContainer.style.display = 'grid';
            gridContainer.style.gridTemplateRows = `repeat(${rows}, minmax(0, 1fr)`;
            gridContainer.style.gridTemplateColumns = `repeat(${columns}, minmax(0, 1fr))`;

            return gridContainer;
        }

        function constructSheet(sheetLayout, querySelector, addClass) {
            const gridContainer = createGrid(querySelector, sheetLayout.columns, sheetLayout.rows);
            (sheetLayout.cells).forEach(function (object) {
                const objectId = object.name;
                const colStart = object.col + 1;
                const rowStart = object.row + 1;
                const colSpan = object.colspan;
                const rowSpan = object.rowspan;
                const objectDiv = document.createElement('div');
                objectDiv.id = objectId;
                objectDiv.style["grid-column"] = `${colStart} / span ${colSpan}`;
                objectDiv.style["grid-row"] = `${rowStart} / span ${rowSpan}`;
                objectDiv.style.border = '2px solid #0000';
                objectDiv.style.margin = '5px';
                objectDiv.classList.add(addClass);
                gridContainer.appendChild(objectDiv);
            })
            return true;
        }

        function renderSheet(config) {
            const qlikConfig = {
              appId: "e1024b45-efa3-421f-b0c0-44d7d1222c7d",
              sheetId: "a8bdb8b2-525e-486e-91d1-7318d362acee"
            }
            requirejs(["js/qlik"], (qlik) => {
                qlik.theme.apply('breeze')                
                const app = qlik.openApp(qlikConfig.appId, config);
                const sheetObject = app.getObject(qlikConfig.sheetId)
                    .then((sheetObject) => {
                        const sheetLayout = sheetObject.getLayout()
                            .then((sheetLayout) => {
                                constructSheet(sheetLayout, "#sheet", "qlikObject");
                                $(`.qlikObject`).each(function () {
                                    var chartId = $(this).attr("id");
                                    app.getObject(this, chartId);
                                });
                            })
                    })
                })
        }

        function renderIframe() {
          //embed chart using single API iframe
          console.log("begin render iframe")
          let iframeSrc = `https://jwt-proxy-combined.qlik.repl.co/single/?appid=e1024b45-efa3-421f-b0c0-44d7d1222c7d&sheet=05743d07-2e17-4c5b-8f81-625c4ee0931b&theme=breeze&opt=ctxmenu,currsel&sessionId=${sessionId}`;
  
          let iframe = document.createElement("iframe");
          iframe.src = iframeSrc;
          iframe.style = "border:none;width:100%;height:100%;"
          document.querySelector("#iframe").appendChild(iframe);
          
          console.log('render an iframe');
        }

        if (!sessionId) {
            window.location = '/login'
        } else {
            registerServiceWorker();
        }

    </script>
</head>

<body>
    <div id="sheet" style="height:800px;"></div>
    <br />
    <div id="iframe" style="height:800px;"></div>
</body>

</html>